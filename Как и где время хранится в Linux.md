```
                 +------------------+
                 |  Аппаратные      |
                 |  таймеры / RTC   |
                 |  (TSC, HPET, RTC)|
                 +--------+---------+
                          |
                          v
                 +------------------+
                 |   clocksource    |
                 | (cycles -> ns)   |
                 +--------+---------+
                          |
                          v
+----------------+  +----------------------+  +--------------------+
|  clockevent /  |  |  Timekeeping core    |  |  NTP / chrony /    |
|  hrtimer (IRQ) |  |  (kernel: xtime,     |  |  PTP (sync daemons)|
|  -> timeouts   |  |   monotonic, offsets)|  |  -> adjtimex/slew  |
+-------+--------+  +----------+-----------+  +--------+-----------+
        |                      |                     ^
        |                      |                     |
        v                      v                     |
    (timer IRQ)         +--------------------+       |
                        |   VDSO / vdso_data | ------+
                        | (fast user access) |
                        +--------+-----------+
                                 |
                                 v
                      +--------------------------+
                      |  Приложения / libc       |
                      |  (clock_gettime,         |
                      |   gettimeofday, timerfd) |
                      +--------------------------+


```
# Аппаратные источники времени 

Цель - дать ядру непрерывный счётчик «тиков», от которых строится системное/монотонное время.

Основные типы:

- RTC (Real Time Clock) — батарейный часовой чип на плате. Сохраняет календарное время при выключении. Обычно читается один раз при загрузке, может использоваться для wake-up/alarms.
- TSC (Time Stamp Counter, x86) — 64-битный счётчик процессора, счётчик циклов CPU (rdtsc). Быстрый, высокоточный, но поведение зависит от CPU (частота, синхронизация между ядрами).
- HPET (High Precision Event Timer) — высокоточный аппаратный таймер, доступен через MMIO.
- ACPI PM timer — простой таймер в ACPI.
- PIT (Programmable Interval Timer) — древний, низко точный.
- ARM arch timer / platform timers — платформенно-зависимые таймеры на ARM.
- PHC (PTP Hardware Clock) — сетевые карты с аппаратной синхронизацией (для PTP). 

> [!danger] Важно: от характеристик и надёжности источника (например, `TSC` может быть неустойчив при смене частоты `CPU`) зависит точность/стабильность `CLOCK_MONOTONIC` и `CLOCK_MONOTONIC_RAW`.
# Clocksource

Цель - обеспечения системы базовой временной шкалой — он предоставляет монотонный атомный счётчик, который позволяет определять текущее время, обеспечивает преобразование значений счётчика в наносекундные значения, учитывает возможность переполнения счётчика и вносит необходимые корректировки, при этом должен работать непрерывно (кроме режима сна системы) и иметь максимально возможное разрешение и стабильную частоту, соответствующую реальному времени.

Отличие от clockevent - если clocksource предоставляет временную шкалу, то clock events генерируют прерывания в определённые моменты на этой шкале, обеспечивая, например, высокоточные таймеры.

Получает на вход:
- счетчик "циклов"
- частоту или коэффициент перевода циклов
` ns ~= (clocksource * mult) >> shift `

# Timekeeping

Цель - отвечает за учёт и управление системным временем, его синхронизацию с учётом данных NTP, поддержку различных форматов времени и учёт времени, проведённого системой в режиме приостановки.

Ключевые идеи и элементы:

- Timekeeping представляет собой систему для управления и учёта системного времени в операционной системе.
- Система обеспечивает синхронизацию времени с использованием NTP для корректировки дрейфа часов.
- Поддерживаются различные форматы времени, включая монотонное и реальное время.
- Учитывается время, проведённое системой в режиме приостановки (suspend), что позволяет корректно рассчитывать общее время работы системы.
- Время реализуется через структуру timekeeper, которая содержит ключевые параметры: используемый источник времени (clocksource), скорректированный множитель для NTP, сдвиг значений, интервалы времени и другие данные.
- Предусмотрены механизмы для обновления и корректировки времени, в том числе при изменении источника времени (clocksource) и после выхода из режима приостановки.
- Обеспечивается защита от гонок данных (race conditions) при одновременном доступе к времени в многозадачном режиме (SMP).
- Реализованы функции для получения текущего времени в различных форматах и для корректировки системного времени.


# Clockevent и таймеры

Цель - отдельная подсистема для доставки событий (будить процесс в заданное время, таймеры). Реализует аппаратные события для планировщика/таймеров.

Виды таймеров:
- `jiffies` / `tick`: исторический периодический «тиковый» счётчик (HZ, например 1000 или 250). Раньше ядро работало по регулярным тикам. Сейчас часто включён режим `nohz` (_tickless_) - ядро программирует аппаратный таймер на ближайшее событие и не дергает регулярные тики, что экономит энергию.
- `hrtimer (high-resolution timers)`: высокоточные таймеры, которые используют clockevent/HPET/TSC и позволяют планировать события с наносекундной точностью.
- `timerfd`, `POSIX timers` , `nanosleep` — пользователи получают таймауты через эти механизмы, которые лежат на clockevent/hrtimer.

# Системные вызовы

Основные syscall:
- `clock_gettime(clockid_t, struct timespec*)` - основной интерфейс для получения времени.
- `gettimeofday(struct timeval*, tz)` - устаревший вариант
- `clock_settime` / `settimeofday` — требуют привилегий; изменяют `CLOCK_REALTIME`.
- `adjtimex(struct timex*)` — низкоуровневый интерфейс для управления частотой/offset (используется `ntpd`/`chronyd`).
- `timer_create`, `timer_settime`, `timerfd_create` — таймеры/события.

Поведение:
- В первую очередь делается вызов `VDSO`, если он не доступен или библиотека настроена иначе - делается _syscall_
- `CLOCK_MONOTONIC` используется для измерения интервалов. `CLOCK_REALTIME` - для календарного времени.


# Синхронизация времени

Демоны - `ntpd`, `chronyd`, `systemd-timesyncd`, `ptp4l` (PTP).
**Как работают:**
- демоны получают эталонное время по сети (NTP/PTP),
- вычисляют смещение и дрейф локальных часов,
- корректируют системное время с помощью:
	- **slew** (медленное изменение частоты через `adjtimex` — безопасно; не делает шагов),
    - **step** (мгновенный settimeofday / clock_settime — прыжок),
    - аппаратная синхронизация (PHC/PTP) — корректировка аппаратного PHC.

**Kernel discipline** - ядро поддерживает логику, которая применяет корректировки частоты (frequency) для плавного изменения времени. `adjtimex` показывает состояние (offset, frequency, status).