```
                 +------------------+
                 |  Аппаратные      |
                 |  таймеры / RTC   |
                 |  (TSC, HPET, RTC)|
                 +--------+---------+
                          |
                          v
                 +------------------+
                 |   clocksource    |
                 | (cycles -> ns)   |
                 +--------+---------+
                          |
                          v
+----------------+  +----------------------+  +--------------------+
|  clockevent /  |  |  Timekeeping core    |  |  NTP / chrony /    |
|  hrtimer (IRQ) |  |  (kernel: xtime,     |  |  PTP (sync daemons)|
|  -> timeouts   |  |   monotonic, offsets)|  |  -> adjtimex/slew  |
+-------+--------+  +----------+-----------+  +--------+-----------+
        |                      |                     ^
        |                      |                     |
        v                      v                     |
    (timer IRQ)         +--------------------+       |
                        |   VDSO / vdso_data | ------+
                        | (fast user access) |
                        +--------+-----------+
                                 |
                                 v
                      +--------------------------+
                      |  Приложения / libc       |
                      |  (clock_gettime,         |
                      |   gettimeofday, timerfd) |
                      +--------------------------+


```
# Аппаратные источники времени 

Цель - дать ядру непрерывный счётчик «тиков», от которых строится системное/монотонное время.

Основные типы:

- RTC (Real Time Clock) — батарейный часовой чип на плате. Сохраняет календарное время при выключении. Обычно читается один раз при загрузке, может использоваться для wake-up/alarms.
- TSC (Time Stamp Counter, x86) — 64-битный счётчик процессора, счётчик циклов CPU (rdtsc). Быстрый, высокоточный, но поведение зависит от CPU (частота, синхронизация между ядрами).
- HPET (High Precision Event Timer) — высокоточный аппаратный таймер, доступен через MMIO.
- ACPI PM timer — простой таймер в ACPI.
- PIT (Programmable Interval Timer) — древний, низко точный.
- ARM arch timer / platform timers — платформенно-зависимые таймеры на ARM.
- PHC (PTP Hardware Clock) — сетевые карты с аппаратной синхронизацией (для PTP). 

> [!danger] Важно: от характеристик и надёжности источника (например, `TSC` может быть неустойчив при смене частоты `CPU`) зависит точность/стабильность `CLOCK_MONOTONIC` и `CLOCK_MONOTONIC_RAW`.
# Clocksource

Цель - обеспечения системы базовой временной шкалой — он предоставляет монотонный атомный счётчик, который позволяет определять текущее время, обеспечивает преобразование значений счётчика в наносекундные значения, учитывает возможность переполнения счётчика и вносит необходимые корректировки, при этом должен работать непрерывно (кроме режима сна системы) и иметь максимально возможное разрешение и стабильную частоту, соответствующую реальному времени.

Отличие от clockevent - если clocksource предоставляет временную шкалу, то clock events генерируют прерывания в определённые моменты на этой шкале, обеспечивая, например, высокоточные таймеры.

Получает на вход:
- счетчик "циклов"
- частоту или коэффициент перевода циклов
` ns ~= (clocksource * mult) >> shift `
